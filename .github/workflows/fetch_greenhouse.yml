name: daily-greenhouse-snapshot

on:
  schedule:
    - cron: "17 3 * * *"   # 03:17 UTC daily
  workflow_dispatch:

permissions:
  contents: read

env:
  GCS_BUCKET: lmi-data     

jobs:
  run-snapshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r requirements.txt

      - name: Export GitHub token for HTTP fetches
        run: echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Run fetch_greenhouse.py -> GCS
        run: |
          INPUT_URL="https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/data/companies.csv"
          OUT_URI="gs://${GCS_BUCKET}/raw/$(date -u +%Y/%m/%d)/greenhouse.jsonl.gz"

          python scripts/fetch_greenhouse.py \
            --input-url "$INPUT_URL" \
            --gcs-uri "$OUT_URI" \
            --workers 8 \
            --timeout 30
          
      - name: Run curate_postings.py -> GCS
        run: |
          RUN_DATE=$(date -u +%Y-%m-%d)
          RAW_PATH="gs://${GCS_BUCKET}/raw/${RUN_DATE//-//}/greenhouse.jsonl.gz"

          ACTIVE_PATH="gs://${GCS_BUCKET}/state/active_postings.parquet"
          CLOSED_DIR="gs://${GCS_BUCKET}/closed"

          echo "RUN_DATE=$RUN_DATE"
          echo "RAW_PATH=$RAW_PATH"

          python scripts/curate_postings.py \
            --run-date "$RUN_DATE" \
            --raw-path "$RAW_PATH" \
            --active-path "$ACTIVE_PATH" \
            --closed-dir "$CLOSED_DIR" \
            --id-column job_id \
            --html-column content_html \
            --text-column content

